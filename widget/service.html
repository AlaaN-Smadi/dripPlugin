<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="buildfire" content="disableTheme,disableFastClick">

	<script src="../../../scripts/buildfire.min.js"></script>
    <script src="../../../scripts/buildfire/services/notifications/localNotifications.js"></script>
    <script>
        function cancelAllPreviousDrips() {
            var sIds = localStorage.getItem("dripIds");
            if (sIds) {
                var ids;

                ids = sIds.split(",");
                localStorage.setItem("dripIds", ids);
                for (var i = 0; i < ids.length; i++) {
                    buildfire.notifications.localNotification.cancel(ids[i], function (e) {
                        if (e) console.error(e);
                    });
                }
            }
        }
        cancelAllPreviousDrips();


        function scheduleDrips(drips){

            if(!drips || !drips.length) return;

            var ids=[];
            var now = new Date();

            for(var i = 0 ; i < drips.length ; i++) {
                var options = {
                    title: drips[i].title
                    ,text: drips[i].text
                    //,data: actionItem
                    ,at: new Date(now.getTime()  + (1000 * 60 * dips[i].days))
                    ,returnToPluginInstanceId: 'home' //optional
                };
                buildfire.notifications.localNotification.schedule(options, function (err, data) {
                    ids.push(data.id);
                });

            }

            ///cheap hack
            setTimeout(function(){
                localStorage.setItem("dripIds",ids);
            },3000);

        }

        buildfire.datastore.get(function(err,result){
            if(err)
                console.error(err);
            else{
                data = result.data;
                if(location.protocol.indexOf('http') < 0)
                    scheduleDrips(data.drips);
            }
        });
    </script>
</head>
<body>

</body>
</html>
