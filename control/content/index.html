<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
	<script src="../../../../scripts/buildfire.min.js"></script>
</head>
<body>
    <div class="content-section-title">
        <span class="top-line"></span>
        <h5>Create Drip</h5>
    </div>

    <section>
        <div class="item clearfix row">
            <div class="labels pull-left col-xs-2">
                <span>Title*</span>
            </div>
            <div class="main pull-left col-xs-10">
                <input id="txtTitle" type="text" class="form-control" placeholder="Enter Title"></span>
            </div>
        </div>
        <div class="item clearfix row">
            <div class="labels pull-left col-xs-2">
                <span>Description*</span>
            </div>
            <div class="main pull-left col-xs-10">
                <input id="txtText" type="text" class="form-control" placeholder="Enter Description">
            </div>
        </div>
        <div class="item clearfix row">
            <div class="labels pull-left col-xs-2 tooltip-holder">
                <span>Days* <span class="tip btn-info-icon btn-primary transition-third padding-left-five" tooltip-placement="top">i <span class="tooltip-container">
                    Occurs when a user doesn't return to the app in the specified amount of days.
                </span></span></span>
            </div>
            <div class="main pull-left col-xs-10">
                <input class="form-control" id="txtDays" type="number" value="1" min="1" max="99">
            </div>
        </div>
    </section>

    <button class="btn btn-primary pull-right" onclick="window.drip.add(); return false;">Add Drip</button>

    <div class="content-section-title">
        <span class="top-line"></span>
        <h5>Current Drips</h5>
    </div>


    <div id="drips" class="content">

    </div>

    <script>
        var data={
            drips:[]
        };

        window.drip = {};

        window.drip.add = function (){
            if(!data.drips)data.drips=[];
            var title = document.getElementById('txtTitle').value;
            var text = document.getElementById("txtText").value;
            var days = document.getElementById("txtDays").value;

            if (!title || !title.length || !text || !text.length || !parseInt(days)){
                return;
            }

            data.drips.push({
                title : title,
                text : text,
                days : parseInt(document.getElementById("txtDays").value),
                createdOn: new Date()
            });

            buildfire.datastore.save(data,function(e){
                if(e)
                    console.error(e);
                else{
                    loadTable(data.drips);
                    document.getElementById("txtTitle").value = '';
                    document.getElementById("txtText").value = '';
                    var days = document.getElementById("txtDays").value;

                    document.getElementById("txtDays").value = (parseInt(days)) ? parseInt(days) + 1 : '';
                }
            });
        };

        function loadTable(drips){
            var dripsContainer = document.getElementById("drips");
            dripsContainer.className = 'drips-container';

            console.log(drips);

            dripsContainer.innerHTML = '';
            if (!drips || !drips.length) return;
            for (var i = 0 ; i < drips.length ; i++) {
                var div = document.createElement('div');
                div.className = (i % 2 == 0) ? 'drip' : 'drip drip-odd';

                var span = document.createElement('span');
                span.innerHTML = drips[i].days + (drips[i].days === 1 ? " Day" : " Days");
                span.className = 'days';
                div.appendChild(span);

                var h1 = document.createElement('h1');
                h1.innerHTML=drips[i].title;
                h1.className = 'title';
                div.appendChild(h1);

                var p = document.createElement('p');
                p.innerHTML=drips[i].text;
                p.className = 'text';
                div.appendChild(p);

                span = document.createElement('span');
                span.innerHTML = "<a class=\"icon icon-cross2 delete-icon\" title=\"Delete\"></a>";
                span.onclick = createDeleteHandler(div, i);
                span.className = 'delete';
                div.appendChild(span);

                span = document.createElement('span');
                span.className = 'tail';
                div.appendChild(span);

                dripsContainer.appendChild(div);
            }

        }

        function createDeleteHandler(drip,i){
            return function() {
                data.drips.splice(i, 1);
                var drips = document.getElementById("drips");
                drips.removeChild(drip);
                buildfire.datastore.save(data,function(e){
                    if(e) console.error(e);
                })
            };
        }

        buildfire.datastore.get(function(err,result){
           if(err)
               console.error(err);
           else{
               data = result.data;
               loadTable(data.drips);
           }
        });

    </script>
</body>
</html>
